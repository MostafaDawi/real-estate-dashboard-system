import requests
import json
import pandas as pd


# ======================================================= DUBIZZLE ======================================================================= 

properties_names = []
properties_price = []

headers = {
    'accept': '*/*',
    'accept-language': 'en-US,en;q=0.9',
    'authorization': 'Basic b2x4LWxiLXByb2R1Y3Rpb24tc2VhcmNoOj5zK08zPXM5QEk0REYwSWEldWc/N1FQdXkye0RqW0Zy',
    'content-type': 'application/x-ndjson',
    'origin': 'https://www.dubizzle.com.lb',
    'priority': 'u=1, i',
    'referer': 'https://www.dubizzle.com.lb/',
    'sec-ch-ua': '"Google Chrome";v="131", "Chromium";v="131", "Not_A Brand";v="24"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'cross-site',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
}

data = '{"index":"olx-lb-production-ads-en"}\n{"from":0,"size":0,"track_total_hits":false,"query":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}}]}},"aggs":{"category.lvl1.externalID":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.lvl0.externalID":"138"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"category.lvl1.externalID","size":20}}}}}},"category.lvl2.externalID":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.lvl1.externalID":"95"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"category.lvl2.externalID","size":20}}}}}},"location.lvl1":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.lvl0.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"location.lvl1.externalID","size":20},"aggs":{"complex_value":{"top_hits":{"size":1,"_source":{"include":["location.lvl1"]}}}}}}}}},"extraFields.property_type":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.property_type","size":20}}}}}},"extraFields.video":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.video","size":20}}}}}},"extraFields.ownership":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.ownership","size":20}}}}}},"extraFields.panorama":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.panorama","size":20}}}}}},"extraFields.payment_option":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.payment_option","size":20}}}}}},"extraFields.rooms":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.rooms","size":20}}}}}},"extraFields.bathrooms":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.bathrooms","size":20}}}}}},"extraFields.furnished":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.furnished","size":20}}}}}},"extraFields.delivery_date":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.delivery_date","size":20}}}}}},"extraFields.floor_level":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.floor_level","size":20}}}}}},"extraFields.features":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.features","size":20}}}}}},"extraFields.new":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.new","size":20}}}}}},"extraFields.hot":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.hot","size":20}}}}}},"extraFields.verified":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.verified","size":20}}}}}},"extraFields.zero_km":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.zero_km","size":20}}}}}},"extraFields.discounted":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.discounted","size":20}}}}}},"extraFields.save_ten_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_ten_percent","size":20}}}}}},"extraFields.save_twenty_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_twenty_percent","size":20}}}}}},"extraFields.save_thirty_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_thirty_percent","size":20}}}}}},"extraFields.save_forty_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_forty_percent","size":20}}}}}},"extraFields.save_fifty_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_fifty_percent","size":20}}}}}},"extraFields.save_sixty_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_sixty_percent","size":20}}}}}},"extraFields.save_seventy_percent":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.save_seventy_percent","size":20}}}}}},"extraFields.eid_collection":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.eid_collection","size":20}}}}}},"extraFields.new_collection":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.new_collection","size":20}}}}}},"extraFields.black_friday":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.black_friday","size":20}}}}}},"extraFields.holidays":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.holidays","size":20}}}}}},"extraFields.ramadan":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.ramadan","size":20}}}}}},"extraFields.weekly_finds":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.weekly_finds","size":20}}}}}},"extraFields.highlights":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.highlights","size":20}}}}}},"extraFields.summer":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.summer","size":20}}}}}},"extraFields.autumn":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"extraFields.autumn","size":20}}}}}},"product":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}},{"bool":{"should":[{"term":{"product":"featured"}},{"term":{"product":"elite"}}]}}]}},"aggs":{"facet":{"terms":{"field":"product","size":20},"aggs":{"complex_value":{"top_hits":{"size":1,"_source":{"include":["product"]}}}}}}}}},"totalProductCount":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"product":"elite"}},{"term":{"product":"featured"}}]}},"aggs":{"facet":{"terms":{"field":"product","size":20},"aggs":{"complex_value":{"top_hits":{"size":1,"_source":{"include":["totalProductCount"]}}}}}}}}},"type":{"global":{},"aggs":{"filtered_agg":{"filter":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"location.externalID":"0-1"}}]}},"aggs":{"facet":{"terms":{"field":"type","size":20}}}}}}}}\n{"index":"olx-lb-production-ads-en"}\n{"from":0,"size":3,"track_total_hits":200000,"query":{"function_score":{"random_score":{"seed":664},"query":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"product":"elite"}}]}}}},"sort":["_score"]}\n{"index":"olx-lb-production-ads-en"}\n{"from":0,"size":8,"track_total_hits":200000,"query":{"function_score":{"random_score":{"seed":664},"query":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}},{"term":{"product":"featured"}}]}}}},"sort":["_score"]}\n{"index":"olx-lb-production-ads-en"}\n{"from":0,"size":34,"track_total_hits":200000,"query":{"bool":{"must":[{"term":{"category.slug":"apartments-villas-for-sale"}}],"must_not":[{"term":{"product":"elite"}}]}},"sort":[{"timestamp":{"order":"desc"}},{"id":{"order":"desc"}}]}\n'

# Wait for response from request
response = requests.post(
    'https://search.mena.sector.run/_msearch?filter_path=took%2C*.took%2C*.suggest.*.options.text%2C*.suggest.*.options._source.*%2C*.hits.total.*%2C*.hits.hits._source.*%2C*.hits.hits._score%2C*.hits.hits.highlight.*%2C*.error%2C*.aggregations.*.buckets.key%2C*.aggregations.*.buckets.doc_count%2C*.aggregations.*.buckets.complex_value.hits.hits._source%2C*.aggregations.*.filtered_agg.facet.buckets.key%2C*.aggregations.*.filtered_agg.facet.buckets.doc_count%2C*.aggregations.*.filtered_agg.facet.buckets.complex_value.hits.hits._source',
    headers=headers,
    data=data,
)

# Result stored as JSON
result = response.json()

# Test: Printing title and prices of properties scraped from dubizzle backend API
i = 1
count = 0

properties_names = []
properties_price = []

while(i < len(result["responses"])):
    properties = result["responses"][i]["hits"]["hits"]
    j = 0
    while j < len(properties):
        # print("{\n\tTitle: "+ properties[j]["_source"]["title"] + "\n\t Price: " + str(properties[j]["_source"]["formattedExtraFields"][1]["formattedValue"]) + "\n}")

        properties_names.append(properties[j]["_source"]["title"])
        properties_price.append(properties[j]["_source"]["formattedExtraFields"][1]["formattedValue"])

        j += 1
        count += 1

        
    i += 1

print(count)


df = pd.DataFrame({"Title": properties_names, "Price": properties_price})
df.to_csv("../extracted_data/dubizzle.csv")